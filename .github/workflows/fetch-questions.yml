name: Fetch Daily Oireachtas Questions (365 days)

on:
  workflow_dispatch:

jobs:
  fetch-daily:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch daily PQ data
        run: |
          mkdir -p data/questions
          touch fetch-log.txt
          echo "üïì Daily fetch started at $(date -u)" > fetch-log.txt

          for day in $(seq -w 0 60); do
            DATE=$(date -d "2025-01-01 +${day} days" +%F)
            FILE="data/questions/day_${DATE}.json"
            URL="https://api.oireachtas.ie/v1/questions?date_start=${DATE}&date_end=${DATE}&limit=4000&qtype=oral,written&show_answers=false"

            echo "üìÖ Day $day: $DATE" | tee -a fetch-log.txt

            attempts=0
            success=false

            while [ $attempts -lt 3 ]; do
              curl -s -w "%{http_code}" -o "$FILE" "$URL" > curl_status.txt
              STATUS=$(tail -n1 curl_status.txt)

              if [ "$STATUS" -eq 200 ]; then
                if jq -e '.message' "$FILE" >/dev/null 2>&1; then
                  echo "‚ö†Ô∏è API error message ‚Äî retrying..." | tee -a fetch-log.txt
                elif jq -e '.results' "$FILE" >/dev/null 2>&1; then
                  COUNT=$(jq '.results | length' "$FILE")
                  if [ "$COUNT" -eq 0 ]; then
                    echo "‚ö†Ô∏è $DATE has no results" | tee -a fetch-log.txt
                  else
                    echo "‚úÖ $DATE OK ‚Äî $COUNT results" | tee -a fetch-log.txt
                  fi
                  success=true
                  break
                else
                  echo "‚ùå Malformed JSON ‚Äî retrying..." | tee -a fetch-log.txt
                fi
              else
                echo "‚ùå HTTP $STATUS ‚Äî retrying..." | tee -a fetch-log.txt
              fi

              attempts=$((attempts + 1))
              echo "‚è≥ Waiting 10s (attempt $((attempts + 1)))"
              sleep 10
            done

            if [ "$success" = false ]; then
              echo "üõë Failed to fetch $DATE after 3 attempts" | tee -a fetch-log.txt
              rm -f "$FILE"
            fi

            echo "üïí Sleeping 10s before next day..." | tee -a fetch-log.txt
            sleep 10
          done

          echo "‚úÖ Daily fetch completed at $(date -u)" >> fetch-log.txt

      - name: Commit daily files to repo
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/questions/*.json fetch-log.txt || echo "No files to add"
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è Nothing to commit"
          else
            git commit -m "Daily PQ fetch for 365 days"
            git push origin HEAD
