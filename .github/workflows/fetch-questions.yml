name: Fetch All Oireachtas Questions (52 weeks)

on:
  workflow_dispatch:

jobs:
  fetch-sequential:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install jq for validation
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch and store questions weekly
        run: |
          mkdir -p data/questions
          for week in $(seq 0 7); do
            START=$(date -d "2025-01-01 +${week} weeks" +%F)
            END=$(date -d "$START +6 days" +%F)
            FILE="data/questions/week_$(printf "%02d" $week).json"
            echo "Fetching week $week: $START to $END"
            curl -s "https://api.oireachtas.ie/v1/questions?date_start=$START&date_end=$END&limit=5000&qtype=oral,written" \
              -o "$FILE"

            if jq empty "$FILE"; then
              echo "✅ Valid JSON for $START to $END"
            else
              echo "❌ Invalid JSON, deleting $FILE"
              rm -f "$FILE"
            fi

            echo "Sleeping for 60 seconds..."
            sleep 60
          done

      - name: Commit weekly files to repo
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/questions/*.json || echo "No files to add"
          echo "Files staged for commit:"
          git diff --cached --name-only

          if git diff --cached --quiet; then
            echo "⚠️ Nothing to commit — skipping push"
          else
            git commit -m "Add all weekly PQ JSON files for 2025"
            git push origin HEAD
          fi
