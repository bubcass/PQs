name: Sequential Weekly Oireachtas Fetch

on:
  workflow_dispatch:

jobs:
  fetch-sequential:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch weekly data sequentially
        run: |
          mkdir -p data/questions

          for week in $(seq 0 51); do
            START=$(date -d "2025-01-01 +${week} weeks" +%F)
            END=$(date -d "$START +6 days" +%F)
            FILE="data/questions/week_$(printf "%02d" $week).json"

            echo "Fetching week $week: $START to $END"

            curl -s "https://api.oireachtas.ie/v1/questions?date_start=$START&date_end=$END&limit=5000&qtype=oral,written" \
              -o "$FILE"

            # Simple check for malformed JSON
            if ! jq empty "$FILE"; then
              echo "⚠️ Failed to fetch or parse week $week ($START to $END)"
              rm -f "$FILE"
            fi

            echo "Sleeping for 60 seconds..."
            sleep 60
          done
