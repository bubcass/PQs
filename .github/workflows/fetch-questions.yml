name: Self-Healing PQ Fetch

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'  # Daily at 4 a.m. GMT

jobs:
  fetch-repair:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create ES module config
        run: echo "{ \"type\": \"module\" }" > package.json

      - name: Fetch missing daily files
        shell: bash
        run: |
          mkdir -p data/questions
          > fetch-log.txt

          START_DATE="2025-01-01"
          END_DATE="2025-12-31"
          TEMPFILE="tmp_day.json"

          current="$START_DATE"
          while [[ "$(date -d "$current" +%s)" -le "$(date -d "$END_DATE" +%s)" ]]; do
            FILE="data/questions/day_${current}.json"
            URL="https://api.oireachtas.ie/v1/questions?date_start=${current}&date_end=${current}&limit=5000&qtype=oral,written&show_answers=false"

            if [ -f "$FILE" ]; then
              echo "‚úÖ $current already exists" | tee -a fetch-log.txt
            else
              echo "üìÖ Fetching $current..." | tee -a fetch-log.txt

              attempts=0
              success=0

              while [ $attempts -lt 5 ]; do
                STATUS=$(curl -s -w "%{http_code}" -o "$TEMPFILE" "$URL")
                if [ "$STATUS" = "200" ] && jq -e '.results' "$TEMPFILE" > /dev/null; then
                  cp "$TEMPFILE" "$FILE"
                  COUNT=$(jq '.results | length' "$FILE")
                  echo "‚úÖ $current OK ‚Äî $COUNT results" | tee -a fetch-log.txt
                  success=1
                  break
                else
                  echo "‚è≥ Retry $((attempts+1)) for $current..." | tee -a fetch-log.txt
                  sleep 10
                fi
                attempts=$((attempts+1))
              done

              if [ $success -eq 0 ]; then
                echo "üõë Failed to fetch $current after 5 attempts" | tee -a fetch-log.txt
              fi
            fi

            current=$(date -I -d "$current + 1 day")
          done

          rm -f "$TEMPFILE"

      - name: Merge daily files
        run: node scripts/merge-days.js

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git fetch origin
          git reset --hard origin/main
          git add data/questions/*.json data/PQs_2025.json fetch-log.txt || echo "No files to add"
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è Nothing to commit"
          else
            git commit -m "Update PQs_2025.json and fill missing daily files"
            git push origin HEAD
